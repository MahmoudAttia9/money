<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Smart Money - Analytics & Debts</title>
    
    <!-- Tailwind CSS (Senior Frontend Choice) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Font: Inter (Professional & Clean) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        dark: '#0f172a',
                        primary: '#2563eb',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b'
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 20px rgba(37, 99, 235, 0.3)',
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .no-scroll::-webkit-scrollbar { display: none; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .safe-top { padding-top: env(safe-area-inset-top, 20px); }
        
        .glass {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .animate-enter { animation: enter 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes enter { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-slate-800 h-[100dvh] flex flex-col overflow-hidden selection:bg-blue-100 selection:text-blue-700">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-[#0f172a] flex flex-col justify-center p-6 animate-enter">
        <div class="absolute top-[-10%] right-[-20%] w-[80%] h-[50%] bg-blue-600/20 rounded-full blur-[80px] pointer-events-none"></div>
        
        <div class="relative z-10 w-full max-w-sm mx-auto">
            <div class="text-center mb-10">
                <div class="w-20 h-20 bg-gradient-to-tr from-blue-600 to-indigo-600 rounded-3xl mx-auto flex items-center justify-center mb-6 shadow-glow transform rotate-3">
                    <i class="fa-solid fa-chart-simple text-white text-3xl"></i>
                </div>
                <h1 class="text-3xl font-black text-white tracking-tight">Smart Money</h1>
                <p class="text-slate-400 text-sm mt-2 font-medium">Financial Control Center</p>
            </div>
            
            <form id="login-form" class="space-y-4">
                <div class="bg-white/5 border border-white/10 rounded-2xl p-1 flex items-center">
                    <div class="w-12 h-12 flex items-center justify-center text-slate-400"><i class="fa-solid fa-phone"></i></div>
                    <input type="tel" id="login-phone" class="bg-transparent w-full text-white font-bold outline-none placeholder:text-slate-600 h-12" placeholder="01xxxxxxxxx" required>
                </div>
                
                <div class="bg-white/5 border border-white/10 rounded-2xl p-1 flex items-center">
                    <div class="w-12 h-12 flex items-center justify-center text-slate-400"><i class="fa-solid fa-lock"></i></div>
                    <input type="password" id="login-pass" class="bg-transparent w-full text-white font-bold outline-none placeholder:text-slate-600 h-12" placeholder="Passcode" required>
                </div>

                <div id="login-error" class="hidden text-rose-400 text-xs font-bold text-center py-2 bg-rose-500/10 rounded-xl">Access Denied</div>

                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-2xl shadow-lg shadow-blue-600/30 transition-all active:scale-[0.98] mt-4">
                    Access Dashboard
                </button>
            </form>
            
            <p class="text-center text-slate-600 text-[10px] font-bold mt-8 uppercase tracking-widest">Authorized for Mohamed Eliwa</p>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="app-container" class="hidden flex-1 flex flex-col h-full bg-[#f8fafc]">
        
        <!-- HEADER -->
        <header class="glass fixed top-0 w-full z-30 safe-top">
            <div class="px-5 py-3 flex justify-between items-center h-16">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-full bg-slate-200 overflow-hidden border border-slate-300 cursor-pointer" onclick="document.getElementById('avatar-upload').click()">
                        <img id="header-avatar" src="" class="w-full h-full object-cover">
                    </div>
                    <div>
                        <h1 class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Total Balance</h1>
                        <p class="text-lg font-black text-slate-900 leading-none" id="header-balance">EGP 0</p>
                    </div>
                </div>
                <button onclick="app.toggleActionSheet()" class="w-9 h-9 bg-slate-900 text-white rounded-full flex items-center justify-center shadow-lg active:scale-95 transition-transform">
                    <i class="fa-solid fa-plus text-sm"></i>
                </button>
            </div>
        </header>

        <!-- CONTENT VIEW -->
        <main id="main-view" class="flex-1 overflow-y-auto no-scroll pt-20 pb-24 px-5 scroll-smooth animate-enter">
            <!-- Dynamic Content -->
        </main>

        <!-- BOTTOM NAV -->
        <nav class="fixed bottom-0 w-full bg-white border-t border-slate-100 z-30 safe-bottom">
            <div class="grid grid-cols-5 pt-2 pb-1">
                <button onclick="app.navigate('dashboard')" id="nav-dashboard" class="nav-item flex flex-col items-center gap-1 p-2 text-slate-400">
                    <i class="fa-solid fa-house text-xl mb-0.5"></i>
                    <span class="text-[10px] font-bold">Home</span>
                </button>
                
                <button onclick="app.navigate('analytics')" id="nav-analytics" class="nav-item flex flex-col items-center gap-1 p-2 text-slate-400">
                    <i class="fa-solid fa-chart-pie text-xl mb-0.5"></i>
                    <span class="text-[10px] font-bold">Analytics</span>
                </button>

                <div class="flex justify-center -mt-8 pointer-events-none">
                    <div class="w-14 h-14 bg-blue-600 rounded-full flex items-center justify-center text-white shadow-lg shadow-blue-600/40 border-[4px] border-[#f8fafc]">
                        <i class="fa-solid fa-wallet text-xl"></i>
                    </div>
                </div>

                <button onclick="app.navigate('debts')" id="nav-debts" class="nav-item flex flex-col items-center gap-1 p-2 text-slate-400">
                    <i class="fa-solid fa-hand-holding-dollar text-xl mb-0.5"></i>
                    <span class="text-[10px] font-bold">Debts</span>
                </button>

                <button onclick="app.navigate('settings')" id="nav-settings" class="nav-item flex flex-col items-center gap-1 p-2 text-slate-400">
                    <i class="fa-solid fa-gear text-xl mb-0.5"></i>
                    <span class="text-[10px] font-bold">Settings</span>
                </button>
            </div>
        </nav>

    </div>

    <!-- ACTION SHEET -->
    <div id="action-sheet" class="fixed inset-0 z-40 bg-slate-900/60 backdrop-blur-sm hidden flex items-end justify-center transition-opacity opacity-0" onclick="app.toggleActionSheet()">
        <div class="bg-white w-full rounded-t-[2rem] p-6 pb-safe-bottom transform translate-y-full transition-transform duration-300 shadow-2xl" id="action-sheet-content" onclick="event.stopPropagation()">
            <div class="w-10 h-1 bg-slate-200 rounded-full mx-auto mb-6"></div>
            <h3 class="text-center font-bold text-slate-800 mb-6">Quick Action</h3>
            <div class="grid grid-cols-4 gap-4">
                <button onclick="modal.open('income')" class="flex flex-col items-center gap-2 group active:scale-95 transition-transform">
                    <div class="w-14 h-14 bg-emerald-50 rounded-2xl flex items-center justify-center border border-emerald-100"><i class="fa-solid fa-arrow-down text-emerald-600 text-xl"></i></div>
                    <span class="text-[10px] font-bold text-slate-500 uppercase">Income</span>
                </button>
                <button onclick="modal.open('expense')" class="flex flex-col items-center gap-2 group active:scale-95 transition-transform">
                    <div class="w-14 h-14 bg-rose-50 rounded-2xl flex items-center justify-center border border-rose-100"><i class="fa-solid fa-arrow-up text-rose-600 text-xl"></i></div>
                    <span class="text-[10px] font-bold text-slate-500 uppercase">Expense</span>
                </button>
                <button onclick="modal.open('debt')" class="flex flex-col items-center gap-2 group active:scale-95 transition-transform">
                    <div class="w-14 h-14 bg-orange-50 rounded-2xl flex items-center justify-center border border-orange-100"><i class="fa-solid fa-handshake text-orange-600 text-xl"></i></div>
                    <span class="text-[10px] font-bold text-slate-500 uppercase">Debt</span>
                </button>
                <button onclick="modal.open('goal')" class="flex flex-col items-center gap-2 group active:scale-95 transition-transform">
                    <div class="w-14 h-14 bg-blue-50 rounded-2xl flex items-center justify-center border border-blue-100"><i class="fa-solid fa-bullseye text-blue-600 text-xl"></i></div>
                    <span class="text-[10px] font-bold text-slate-500 uppercase">Goal</span>
                </button>
            </div>
        </div>
    </div>

    <!-- UNIVERSAL MODAL -->
    <div id="modal-overlay" class="fixed inset-0 z-50 bg-slate-900/80 backdrop-blur-md hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-200">
        <div class="bg-white w-full max-w-md rounded-[2rem] shadow-2xl overflow-hidden transform scale-95 transition-transform duration-200" id="modal-content">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="font-bold text-lg text-slate-800" id="modal-title">Title</h3>
                <button onclick="modal.close()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center hover:bg-slate-200"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6">
                <form id="dynamic-form" class="space-y-5"></form>
            </div>
            <div class="px-6 py-4 bg-slate-50 border-t border-slate-100">
                <button form="dynamic-form" type="submit" class="w-full bg-slate-900 text-white font-bold py-4 rounded-xl shadow-lg active:scale-[0.98] transition-all">Save Record</button>
            </div>
        </div>
    </div>

    <input type="file" id="avatar-upload" hidden accept="image/*" onchange="app.handleImageUpload(this)">

<script>
// --- CONFIG & STORE ---
const CONFIG = { phone: '01281507604', pass: '11223344', defaultName: 'Mohamed Eliwa' };

const Store = {
    get: (k) => JSON.parse(localStorage.getItem(k) || '[]'),
    set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
    getUser: () => {
        const u = JSON.parse(localStorage.getItem('userProfile') || '{}');
        return { name: u.name || CONFIG.defaultName, avatar: u.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(u.name || CONFIG.defaultName)}&background=0f172a&color=fff&size=256` };
    },
    updateUser: (data) => {
        const current = Store.getUser();
        localStorage.setItem('userProfile', JSON.stringify({ ...current, ...data }));
        app.updateProfileUI();
    },
    // Transactions
    addTx: (tx) => { const d = Store.get('transactions'); d.push({ ...tx, id: Date.now(), amount: parseFloat(tx.amount) }); Store.set('transactions', d); },
    deleteTx: (id) => Store.set('transactions', Store.get('transactions').filter(t => t.id != id)),
    // Debts
    addDebt: (d) => { const data = Store.get('debts'); data.push({ ...d, id: Date.now(), totalAmount: parseFloat(d.totalAmount), paidAmount: 0 }); Store.set('debts', data); },
    payDebt: (id, amt) => {
        const debts = Store.get('debts'); const idx = debts.findIndex(d => d.id == id);
        if(idx > -1) {
            debts[idx].paidAmount += amt; Store.set('debts', debts);
            const isBorrowed = debts[idx].type === 'borrowed';
            Store.addTx({ title: `Debt: ${debts[idx].title}`, amount: amt, type: isBorrowed ? 'expense' : 'income', category: 'Debt Repayment', date: new Date().toISOString().split('T')[0] });
        }
    },
    deleteDebt: (id) => Store.set('debts', Store.get('debts').filter(d => d.id != id)),
    // Goals
    addGoal: (g) => { const data = Store.get('goals'); data.push({ ...g, id: Date.now(), target: parseFloat(g.target), saved: 0 }); Store.set('goals', data); },
    
    // Logic
    getBalance: () => {
        const txs = Store.get('transactions');
        const income = txs.filter(t => t.type === 'income').reduce((a,b) => a + b.amount, 0);
        const expense = txs.filter(t => t.type === 'expense').reduce((a,b) => a + b.amount, 0);
        return { income, expense, total: income - expense };
    }
};

// --- AUTH ---
const Auth = {
    init: () => {
        if(localStorage.getItem('isLoggedIn') === 'true') Auth.success();
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const p = document.getElementById('login-phone').value.replace(/\s/g, '');
            const pass = document.getElementById('login-pass').value;
            if(p === CONFIG.phone && pass === CONFIG.pass) { localStorage.setItem('isLoggedIn', 'true'); Auth.success(); } 
            else { document.getElementById('login-error').classList.remove('hidden'); }
        });
    },
    success: () => {
        const screen = document.getElementById('login-screen');
        screen.style.opacity = '0';
        setTimeout(() => { screen.classList.add('hidden'); document.getElementById('app-container').classList.remove('hidden'); app.init(); }, 400);
    }
};

// --- APP ---
const app = {
    view: 'dashboard',
    filterMode: 'monthly',
    filterValue: new Date().toISOString().slice(0, 7),

    init: () => {
        app.updateProfileUI();
        app.navigate('dashboard');
    },

    updateProfileUI: () => {
        const user = Store.getUser();
        const balance = Store.getBalance().total;
        document.getElementById('header-avatar').src = user.avatar;
        document.getElementById('header-balance').innerText = `EGP ${balance.toLocaleString()}`;
    },

    handleImageUpload: (input) => {
        if(input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => Store.updateUser({ avatar: e.target.result });
            reader.readAsDataURL(input.files[0]);
        }
    },

    navigate: (v) => {
        app.view = v;
        document.querySelectorAll('.nav-item').forEach(el => { el.classList.remove('text-blue-600'); el.classList.add('text-slate-400'); });
        const active = document.getElementById(`nav-${v}`);
        if(active) { active.classList.remove('text-slate-400'); active.classList.add('text-blue-600'); }
        
        const main = document.getElementById('main-view');
        main.innerHTML = '';
        setTimeout(() => {
            if(v === 'dashboard') main.innerHTML = views.dashboard();
            else if(v === 'analytics') main.innerHTML = views.analytics();
            else if(v === 'debts') main.innerHTML = views.debts();
            else if(v === 'settings') main.innerHTML = views.settings();
            
            if(v === 'analytics') app.drawCharts();
        }, 10);
    },

    toggleActionSheet: () => {
        const el = document.getElementById('action-sheet');
        const content = document.getElementById('action-sheet-content');
        if(el.classList.contains('hidden')) {
            el.classList.remove('hidden');
            setTimeout(() => { el.classList.remove('opacity-0'); content.classList.remove('translate-y-full'); }, 10);
        } else {
            content.classList.add('translate-y-full'); el.classList.add('opacity-0');
            setTimeout(() => el.classList.add('hidden'), 300);
        }
    },

    setFilterMode: (m) => { app.filterMode = m; const now=new Date(); app.filterValue = m==='daily'?now.toISOString().slice(0,10) : m==='monthly'?now.toISOString().slice(0,7) : now.getFullYear().toString(); app.navigate('analytics'); },
    setFilterValue: (v) => { if(v) { app.filterValue = v; app.navigate('analytics'); } },

    getAnalyticsData: () => {
        const txs = Store.get('transactions');
        let filteredTxs = [];
        if(app.filterMode === 'daily') filteredTxs = txs.filter(t => t.date === app.filterValue);
        else if(app.filterMode === 'monthly') filteredTxs = txs.filter(t => t.date.startsWith(app.filterValue));
        else filteredTxs = txs.filter(t => t.date.startsWith(app.filterValue));

        const income = filteredTxs.filter(t => t.type === 'income').reduce((a,b)=>a+b.amount,0);
        const expense = filteredTxs.filter(t => t.type === 'expense').reduce((a,b)=>a+b.amount,0);
        const cats = {}; filteredTxs.filter(t=>t.type==='expense').forEach(t => cats[t.category] = (cats[t.category]||0)+t.amount);
        
        return { income, expense, cats };
    },

    drawCharts: () => {
        const data = app.getAnalyticsData();
        const ctx = document.getElementById('chartCats');
        if(!ctx) return;
        if(Chart.getChart(ctx)) Chart.getChart(ctx).destroy();
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(data.cats).length ? Object.keys(data.cats) : ['No Data'],
                datasets: [{
                    data: Object.values(data.cats).length ? Object.values(data.cats) : [1],
                    backgroundColor: ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899', '#6366f1'],
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, font: {family: 'Inter', size: 11} } } } }
        });
    }
};

// --- VIEWS ---
const views = {
    dashboard: () => {
        const balance = Store.getBalance();
        const txs = Store.get('transactions').slice(-5).reverse();
        return `
        <div class="space-y-6">
            <div class="bg-slate-900 rounded-[2rem] p-6 text-white shadow-lg relative overflow-hidden">
                <div class="absolute top-0 right-0 w-40 h-40 bg-blue-500 rounded-full blur-[60px] opacity-20 pointer-events-none"></div>
                <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-1">Available</p>
                <h2 class="text-4xl font-black mb-6">EGP ${balance.total.toLocaleString()}</h2>
                <div class="flex gap-4">
                    <div class="flex-1 bg-white/10 rounded-xl p-3 border border-white/5">
                        <div class="flex items-center gap-2 mb-1"><div class="w-2 h-2 rounded-full bg-emerald-400"></div><span class="text-[10px] text-slate-300 font-bold uppercase">Income</span></div>
                        <p class="font-bold text-lg">${balance.income.toLocaleString()}</p>
                    </div>
                    <div class="flex-1 bg-white/10 rounded-xl p-3 border border-white/5">
                        <div class="flex items-center gap-2 mb-1"><div class="w-2 h-2 rounded-full bg-rose-400"></div><span class="text-[10px] text-slate-300 font-bold uppercase">Expense</span></div>
                        <p class="font-bold text-lg">${balance.expense.toLocaleString()}</p>
                    </div>
                </div>
            </div>
            
            <div>
                <h3 class="font-bold text-slate-800 text-lg mb-4 px-1">Recent Activity</h3>
                <div class="space-y-3">
                    ${txs.length === 0 ? '<div class="text-center py-8 text-slate-400 text-sm font-medium">No transactions yet</div>' : txs.map(t => `
                        <div class="bg-white p-4 rounded-2xl shadow-soft flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-xl flex items-center justify-center text-lg ${t.type === 'income' ? 'bg-emerald-50 text-emerald-600' : 'bg-slate-50 text-slate-600'}">
                                    <i class="fa-solid ${t.category.includes('Debt') ? 'fa-handshake' : t.type === 'income' ? 'fa-arrow-down' : 'fa-bag-shopping'}"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-800 text-sm">${t.title}</h4>
                                    <p class="text-[10px] text-slate-400 font-bold uppercase">${t.category}</p>
                                </div>
                            </div>
                            <span class="font-bold ${t.type === 'income' ? 'text-emerald-600' : 'text-slate-800'}">
                                ${t.type === 'income' ? '+' : '-'} ${t.amount.toLocaleString()}
                            </span>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>`;
    },

    analytics: () => {
        const data = app.getAnalyticsData();
        return `
        <div class="space-y-6">
            <div class="flex justify-between items-end">
                <h2 class="text-2xl font-bold text-slate-800">Analytics</h2>
                <div class="flex bg-white rounded-lg p-1 shadow-sm border border-slate-200">
                    <button onclick="app.setFilterMode('monthly')" class="px-3 py-1 text-[10px] font-bold rounded-md ${app.filterMode === 'monthly' ? 'bg-slate-900 text-white' : 'text-slate-500'}">Month</button>
                    <button onclick="app.setFilterMode('yearly')" class="px-3 py-1 text-[10px] font-bold rounded-md ${app.filterMode === 'yearly' ? 'bg-slate-900 text-white' : 'text-slate-500'}">Year</button>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-emerald-500 text-white p-5 rounded-3xl shadow-lg shadow-emerald-500/20">
                    <p class="text-emerald-100 text-xs font-bold uppercase mb-1">Income</p>
                    <p class="text-2xl font-black">${data.income.toLocaleString()}</p>
                </div>
                <div class="bg-rose-500 text-white p-5 rounded-3xl shadow-lg shadow-rose-500/20">
                    <p class="text-rose-100 text-xs font-bold uppercase mb-1">Expense</p>
                    <p class="text-2xl font-black">${data.expense.toLocaleString()}</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-[2rem] shadow-soft border border-slate-100">
                <h3 class="font-bold text-slate-800 mb-6 text-sm flex items-center gap-2"><i class="fa-solid fa-chart-pie text-blue-500"></i> Spending Breakdown</h3>
                <div class="h-64 relative">
                    <canvas id="chartCats"></canvas>
                </div>
            </div>
        </div>`;
    },

    debts: () => {
        const debts = Store.get('debts');
        const iOwe = debts.filter(d => d.type === 'borrowed').reduce((a,b) => a + (b.totalAmount - b.paidAmount), 0);
        const owedToMe = debts.filter(d => d.type === 'lent').reduce((a,b) => a + (b.totalAmount - b.paidAmount), 0);
        return `
        <div class="space-y-6">
            <h2 class="text-2xl font-bold text-slate-800">Debt Manager</h2>
            <div class="flex gap-4 overflow-x-auto no-scroll pb-2">
                <div class="min-w-[160px] bg-white p-5 rounded-3xl shadow-soft border-l-4 border-rose-500">
                    <p class="text-[10px] text-slate-400 font-bold uppercase">You Owe</p>
                    <p class="text-xl font-black text-rose-600 mt-1">${iOwe.toLocaleString()}</p>
                </div>
                <div class="min-w-[160px] bg-white p-5 rounded-3xl shadow-soft border-l-4 border-emerald-500">
                    <p class="text-[10px] text-slate-400 font-bold uppercase">Owed to You</p>
                    <p class="text-xl font-black text-emerald-600 mt-1">${owedToMe.toLocaleString()}</p>
                </div>
            </div>
            
            <div class="space-y-4">
                ${debts.length === 0 ? '<div class="text-center py-10 text-slate-400 text-sm">No active debts</div>' : debts.map(d => {
                    const remaining = d.totalAmount - d.paidAmount;
                    const pct = Math.round((d.paidAmount / d.totalAmount) * 100);
                    return remaining > 0 ? `
                    <div class="bg-white p-5 rounded-3xl shadow-soft relative">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex gap-3">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center text-sm ${d.type === 'borrowed' ? 'bg-rose-50 text-rose-600' : 'bg-emerald-50 text-emerald-600'}">
                                    <i class="fa-solid ${d.type === 'borrowed' ? 'fa-arrow-down' : 'fa-arrow-up'}"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-slate-800 text-sm">${d.title}</h3>
                                    <p class="text-[10px] text-slate-400 font-bold uppercase">${d.type === 'borrowed' ? 'Borrowed' : 'Lent'}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-slate-400 font-bold">Remaining</p>
                                <p class="font-black text-slate-800 text-lg">${remaining.toLocaleString()}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 mb-4">
                            <div class="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden">
                                <div class="h-full rounded-full ${d.type === 'borrowed' ? 'bg-rose-500' : 'bg-emerald-500'}" style="width: ${pct}%"></div>
                            </div>
                            <span class="text-xs font-bold text-slate-400">${pct}%</span>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="modal.openPayDebt(${d.id}, '${d.type}')" class="flex-1 bg-slate-900 text-white text-xs font-bold py-3 rounded-xl active:scale-95 transition-transform">${d.type === 'borrowed' ? 'Pay Off' : 'Collect'}</button>
                            <button onclick="Store.deleteDebt(${d.id}); app.navigate('debts')" class="w-10 bg-slate-50 text-slate-400 rounded-xl flex items-center justify-center hover:text-rose-500"><i class="fa-solid fa-trash text-xs"></i></button>
                        </div>
                    </div>` : '';
                }).join('')}
            </div>
        </div>`;
    },

    settings: () => `
        <div class="space-y-6">
            <h2 class="text-2xl font-bold text-slate-800">Settings</h2>
            <div class="bg-white rounded-3xl p-6 shadow-soft text-center" onclick="document.getElementById('avatar-upload').click()">
                <div class="w-24 h-24 mx-auto rounded-full overflow-hidden border-4 border-slate-50 shadow-lg mb-4">
                    <img id="settings-avatar" src="${Store.getUser().avatar}" class="w-full h-full object-cover">
                </div>
                <h3 class="font-bold text-xl text-slate-800">${Store.getUser().name}</h3>
                <p class="text-xs text-slate-400 font-bold uppercase tracking-wider">Tap to change photo</p>
            </div>
            <div class="bg-white rounded-3xl overflow-hidden shadow-soft">
                <button onclick="Store.reset()" class="w-full p-5 flex items-center justify-between hover:bg-rose-50 transition-colors group">
                    <span class="font-bold text-rose-500">Reset All Data</span>
                    <i class="fa-solid fa-trash text-rose-300 group-hover:text-rose-500"></i>
                </button>
                <button onclick="localStorage.clear(); location.reload()" class="w-full p-5 flex items-center justify-between hover:bg-slate-50 transition-colors border-t border-slate-50">
                    <span class="font-bold text-slate-700">Log Out</span>
                    <i class="fa-solid fa-right-from-bracket text-slate-400"></i>
                </button>
            </div>
        </div>`
};

const modal = {
    overlay: document.getElementById('modal-overlay'), form: document.getElementById('dynamic-form'), title: document.getElementById('modal-title'),
    open: (type) => {
        app.toggleActionSheet(); modal.overlay.classList.remove('hidden'); setTimeout(() => { modal.overlay.classList.remove('opacity-0'); document.getElementById('modal-content').classList.remove('scale-95'); }, 10);
        const inputClass = "w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-4 font-bold text-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-900 transition-all";
        const labelClass = "block text-xs font-bold text-slate-400 uppercase mb-2 ml-1";
        
        let html = '';
        if (type === 'debt') {
            modal.title.innerText = 'Add New Debt';
            html = `<div><label class="${labelClass}">Type</label><div class="grid grid-cols-2 gap-3"><label class="cursor-pointer"><input type="radio" name="type" value="borrowed" class="peer sr-only" checked><div class="p-3 text-center rounded-xl border border-slate-200 peer-checked:bg-rose-500 peer-checked:text-white peer-checked:border-rose-500 transition-all font-bold text-sm">I Borrowed</div></label><label class="cursor-pointer"><input type="radio" name="type" value="lent" class="peer sr-only"><div class="p-3 text-center rounded-xl border border-slate-200 peer-checked:bg-emerald-500 peer-checked:text-white peer-checked:border-emerald-500 transition-all font-bold text-sm">I Lent</div></label></div></div><div><label class="${labelClass}">Person Name / Title</label><input type="text" name="title" class="${inputClass}" required></div><div><label class="${labelClass}">Total Amount</label><input type="number" name="totalAmount" class="${inputClass}" required></div>`;
        } else if (type === 'income' || type === 'expense') {
            modal.title.innerText = `Add ${type}`;
            html = `<div><label class="${labelClass}">Amount</label><input type="number" step="0.01" name="amount" class="${inputClass} text-2xl" required></div><div><label class="${labelClass}">Description</label><input type="text" name="title" class="${inputClass}" required></div><div><label class="${labelClass}">Category</label><select name="category" class="${inputClass}"><option>Food</option><option>Transport</option><option>Shopping</option><option>Bills</option><option>Salary</option><option>Other</option></select></div><input type="hidden" name="date" value="${new Date().toISOString().split('T')[0]}">`;
        } else if (type === 'goal') {
            modal.title.innerText = 'New Savings Goal';
            html = `<div><label class="${labelClass}">Goal Name</label><input type="text" name="title" class="${inputClass}" required></div><div><label class="${labelClass}">Target Amount</label><input type="number" name="target" class="${inputClass}" required></div>`;
        }
        modal.form.innerHTML = html;
        modal.form.onsubmit = (e) => { e.preventDefault(); const data = Object.fromEntries(new FormData(modal.form)); if(type==='debt') Store.addDebt(data); else if(type==='goal') Store.addGoal(data); else Store.addTx({...data, type}); modal.close(); app.navigate(type === 'debt' ? 'debts' : 'dashboard'); app.updateProfileUI(); };
    },
    openPayDebt: (id, type) => {
        modal.overlay.classList.remove('hidden'); setTimeout(() => { modal.overlay.classList.remove('opacity-0'); document.getElementById('modal-content').classList.remove('scale-95'); }, 10);
        modal.title.innerText = type === 'borrowed' ? 'Pay Off Debt' : 'Collect Money';
        modal.form.innerHTML = `<div class="py-4 text-center"><label class="block text-xs font-bold text-slate-400 uppercase mb-4">Amount</label><input type="number" step="0.01" name="amount" class="w-full bg-slate-50 border-b-2 border-slate-300 text-center text-4xl font-black text-slate-800 focus:outline-none focus:border-slate-900 pb-2 bg-transparent" placeholder="0" required autofocus></div>`;
        modal.form.onsubmit = (e) => { e.preventDefault(); Store.payDebt(id, parseFloat(new FormData(modal.form).get('amount'))); modal.close(); app.navigate('debts'); app.updateProfileUI(); };
    },
    close: () => { modal.overlay.classList.add('opacity-0'); document.getElementById('modal-content').classList.add('scale-95'); setTimeout(() => modal.overlay.classList.add('hidden'), 200); }
};

Auth.init();
</script>
</body>
</html>
