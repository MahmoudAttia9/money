<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Money Manager</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .transition-all { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* Hide scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none;  scrollbar-width: none; }

        /* Login Screen */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0f172a; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }

        @media print {
            aside, header button, .no-print, .bottom-nav { display: none !important; }
            body { background: white; }
            main { margin: 0; padding: 20px; padding-bottom: 0 !important; }
        }

        @media (max-width: 768px) {
            .mobile-pb { padding-bottom: 100px !important; }
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex overflow-hidden bg-slate-50">

    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm mx-4">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-500/50">
                    <i class="fa-solid fa-shield-halved text-white text-3xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-800">Welcome Back</h2>
                <p class="text-slate-500 text-sm">Secure Access Required</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Phone Number</label>
                    <input type="text" id="login-phone" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="01xxxxxxxxx">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                    <input type="password" id="login-pass" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="••••••••">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition-transform active:scale-95">Unlock App</button>
            </form>
            <p id="login-error" class="text-red-500 text-center text-sm mt-4 hidden">Invalid Credentials</p>
        </div>
    </div>

    <!-- Desktop Sidebar -->
    <aside class="w-64 bg-slate-900 text-white flex-col hidden md:flex shadow-xl z-20">
        <div class="p-6 border-b border-slate-700">
            <h1 class="text-xl font-bold tracking-wide flex items-center gap-2">
                <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                    <i class="fa-solid fa-wallet text-white text-sm"></i>
                </div>
                SmartFlow
            </h1>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="app.navigate('dashboard')" id="nav-dashboard" class="nav-item w-full text-left px-4 py-3 rounded-xl hover:bg-slate-800 transition-colors flex items-center gap-3">
                <i class="fa-solid fa-chart-line w-5 text-center"></i> Dashboard
            </button>
            <button onclick="app.navigate('transactions')" id="nav-transactions" class="nav-item w-full text-left px-4 py-3 rounded-xl hover:bg-slate-800 transition-colors flex items-center gap-3">
                <i class="fa-solid fa-money-bill-transfer w-5 text-center"></i> Transactions
            </button>
            <button onclick="app.navigate('debts')" id="nav-debts" class="nav-item w-full text-left px-4 py-3 rounded-xl hover:bg-slate-800 transition-colors flex items-center gap-3">
                <i class="fa-solid fa-credit-card w-5 text-center"></i> Debts
            </button>
            <button onclick="app.navigate('goals')" id="nav-goals" class="nav-item w-full text-left px-4 py-3 rounded-xl hover:bg-slate-800 transition-colors flex items-center gap-3">
                <i class="fa-solid fa-bullseye w-5 text-center"></i> Goals
            </button>
            <button onclick="app.navigate('settings')" id="nav-settings" class="nav-item w-full text-left px-4 py-3 rounded-xl hover:bg-slate-800 transition-colors flex items-center gap-3">
                <i class="fa-solid fa-gear w-5 text-center"></i> Settings
            </button>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden relative w-full">
        
        <!-- Mobile Top Bar -->
        <div class="md:hidden bg-white px-4 py-3 flex justify-between items-center shadow-sm z-10 sticky top-0">
            <h1 class="font-bold text-lg flex items-center gap-2 text-slate-800">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-blue-200 shadow-lg">
                    <i class="fa-solid fa-wallet text-sm"></i>
                </div>
                SmartFlow
            </h1>
            <button onclick="app.logout()" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-600">
                <i class="fa-solid fa-right-from-bracket text-sm"></i>
            </button>
        </div>

        <!-- Filter Header (Dropdowns) -->
        <header class="bg-white/80 backdrop-blur-md border-b border-gray-200 p-4 z-10">
            <div class="max-w-6xl mx-auto w-full flex flex-col sm:flex-row justify-between items-center gap-4">
                
                <!-- Month/Year Selectors -->
                <div class="flex items-center gap-2 w-full sm:w-auto">
                    <div class="relative flex-1 sm:flex-none">
                        <i class="fa-solid fa-calendar absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <select id="filter-month" onchange="app.updateDateFilter()" class="w-full sm:w-40 pl-9 pr-8 py-2 bg-white border border-gray-200 rounded-xl text-sm font-medium focus:ring-2 focus:ring-blue-500 outline-none appearance-none cursor-pointer">
                            <!-- Months injected via JS -->
                        </select>
                        <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs pointer-events-none"></i>
                    </div>
                    <div class="relative flex-1 sm:flex-none">
                        <select id="filter-year" onchange="app.updateDateFilter()" class="w-full sm:w-28 px-4 py-2 bg-white border border-gray-200 rounded-xl text-sm font-medium focus:ring-2 focus:ring-blue-500 outline-none appearance-none cursor-pointer">
                            <!-- Years injected via JS -->
                        </select>
                        <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs pointer-events-none"></i>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="grid grid-cols-2 gap-3 w-full sm:w-auto">
                    <button onclick="modal.open('income')" class="flex items-center justify-center gap-2 bg-emerald-600 text-white hover:bg-emerald-700 px-4 py-2 rounded-xl text-sm font-semibold transition-colors shadow-sm">
                        <i class="fa-solid fa-plus"></i> Income
                    </button>
                    <button onclick="modal.open('expense')" class="flex items-center justify-center gap-2 bg-rose-600 text-white hover:bg-rose-700 px-4 py-2 rounded-xl text-sm font-semibold transition-colors shadow-sm">
                        <i class="fa-solid fa-minus"></i> Expense
                    </button>
                </div>
            </div>
        </header>

        <!-- Scrollable Content Area -->
        <div id="main-view" class="flex-1 overflow-y-auto overflow-x-hidden p-4 pb-32 md:pb-12 bg-slate-50 mobile-pb scroll-smooth">
            <!-- Content Injected via JS -->
        </div>

    </main>

    <!-- Mobile Bottom Navigation -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 px-6 py-2 pb-safe z-30 flex justify-between items-center shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] bottom-nav h-[70px]">
        <button onclick="app.navigate('dashboard')" id="mob-nav-dashboard" class="mob-nav-item flex flex-col items-center gap-1 p-2 text-blue-600 transition-colors">
            <i class="fa-solid fa-chart-line text-xl"></i>
            <span class="text-[10px] font-medium">Dash</span>
        </button>
        <button onclick="app.navigate('transactions')" id="mob-nav-transactions" class="mob-nav-item flex flex-col items-center gap-1 p-2 text-slate-400 hover:text-slate-600 transition-colors">
            <i class="fa-solid fa-list text-xl"></i>
            <span class="text-[10px] font-medium">History</span>
        </button>
        <div class="relative -top-6">
            <button onclick="modal.open('expense')" class="w-14 h-14 bg-blue-600 rounded-full flex items-center justify-center text-white shadow-lg shadow-blue-300 active:scale-90 transition-transform">
                <i class="fa-solid fa-plus text-2xl"></i>
            </button>
        </div>
        <button onclick="app.navigate('goals')" id="mob-nav-goals" class="mob-nav-item flex flex-col items-center gap-1 p-2 text-slate-400 hover:text-slate-600 transition-colors">
            <i class="fa-solid fa-bullseye text-xl"></i>
            <span class="text-[10px] font-medium">Goals</span>
        </button>
        <button onclick="app.navigate('debts')" id="mob-nav-debts" class="mob-nav-item flex flex-col items-center gap-1 p-2 text-slate-400 hover:text-slate-600 transition-colors">
            <i class="fa-solid fa-credit-card text-xl"></i>
            <span class="text-[10px] font-medium">Debts</span>
        </button>
    </nav>

    <!-- Universal Modal -->
    <div id="modal-overlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-50 flex items-end sm:items-center justify-center sm:p-4 transition-opacity duration-300">
        <div class="bg-white w-full sm:max-w-md sm:rounded-2xl rounded-t-3xl shadow-2xl overflow-hidden transform transition-transform duration-300 translate-y-full sm:translate-y-0" id="modal-content">
            <div class="bg-white px-6 py-4 border-b border-gray-100 flex justify-between items-center sticky top-0 z-10">
                <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2" id="modal-title">Add Item</h3>
                <button onclick="modal.close()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:bg-gray-200 transition-colors"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 max-h-[75vh] overflow-y-auto">
                <form id="dynamic-form" class="space-y-5">
                    <!-- Form fields injected here -->
                </form>
            </div>
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex gap-3 pb-8 sm:pb-4">
                <button onclick="modal.close()" class="flex-1 px-4 py-3 text-gray-700 bg-white border border-gray-200 rounded-xl font-semibold hover:bg-gray-50 active:scale-95 transition-all">Cancel</button>
                <button form="dynamic-form" type="submit" class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-xl font-semibold shadow-lg shadow-blue-200 hover:bg-blue-700 active:scale-95 transition-all">Save</button>
            </div>
        </div>
    </div>

<script>
// --- AUTHENTICATION ---
const Auth = {
    check: () => {
        const isLogged = sessionStorage.getItem('isLogged');
        if (!isLogged) {
            document.getElementById('login-screen').classList.remove('hidden');
        } else {
            document.getElementById('login-screen').classList.add('hidden');
            app.init();
        }
    },
    login: (phone, pass) => {
        // Hardcoded Credentials
        if (phone.replace(/\s/g, '') === '01281507604' && pass === '11223344') {
            sessionStorage.setItem('isLogged', 'true');
            document.getElementById('login-screen').classList.add('hidden');
            app.init();
        } else {
            document.getElementById('login-error').classList.remove('hidden');
        }
    },
    logout: () => {
        sessionStorage.removeItem('isLogged');
        location.reload();
    }
};

// --- CHART GLOBALS ---
let chartInstances = {};

// --- ENGINE ---
const MoneyFlowEngine = {
    // Filter by specific Month and Year
    filterByDate: (transactions, month, year) => {
        return transactions.filter(t => {
            const d = new Date(t.date);
            return d.getMonth() === parseInt(month) && d.getFullYear() === parseInt(year);
        });
    },

    calculateStats: (transactions) => {
        const income = transactions.filter(t => t.type === 'income').reduce((s, t) => s + parseFloat(t.amount), 0);
        const expense = transactions.filter(t => t.type === 'expense').reduce((s, t) => s + parseFloat(t.amount), 0);
        return { income, expense, net: income - expense, savingsRate: income > 0 ? ((income - expense) / income) * 100 : 0 };
    },

    getInsights: (transactions) => {
        if(transactions.length === 0) return null;
        
        // Expense transactions only
        const expenses = transactions.filter(t => t.type === 'expense');
        if(expenses.length === 0) return null;

        // Max Day
        const days = {};
        expenses.forEach(t => { days[t.date] = (days[t.date] || 0) + parseFloat(t.amount); });
        const maxDay = Object.keys(days).reduce((a, b) => days[a] > days[b] ? a : b);

        // Max Category
        const cats = {};
        expenses.forEach(t => { cats[t.category] = (cats[t.category] || 0) + parseFloat(t.amount); });
        const maxCat = Object.keys(cats).reduce((a, b) => cats[a] > cats[b] ? a : b);

        return { maxDay, maxDayAmount: days[maxDay], maxCat, maxCatAmount: cats[maxCat] };
    },

    // Daily Trend for Line Chart
    getDailyTrend: (transactions, month, year) => {
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const labels = Array.from({length: daysInMonth}, (_, i) => i + 1);
        const data = new Array(daysInMonth).fill(0);
        
        transactions.filter(t => t.type === 'expense').forEach(t => {
            const d = new Date(t.date).getDate();
            data[d-1] += parseFloat(t.amount);
        });
        return { labels, data };
    }
};

// --- STORE ---
const Store = {
    get: (key) => JSON.parse(localStorage.getItem(key) || '[]'),
    set: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
    add: (key, item) => {
        const data = Store.get(key);
        data.push({ ...item, id: Date.now() });
        Store.set(key, data);
    },
    updateGoal: (id, amount) => {
        const goals = Store.get('goals');
        const idx = goals.findIndex(g => g.id == id);
        if(idx > -1) {
            goals[idx].savedAmount += parseFloat(amount);
            // Optionally update 'transactions' to reflect this saving if it's considered an expense or transfer
            // For now keeping it simple as requested
            Store.set('goals', goals);
        }
    },
    delete: (key, id) => {
        const data = Store.get(key).filter(i => i.id != id);
        Store.set(key, data);
    }
};

// --- APP ---
const app = {
    currentView: 'dashboard',
    filter: { month: new Date().getMonth(), year: new Date().getFullYear() },

    init: () => {
        // Init Date Selectors
        app.renderDateSelectors();
        
        // Seed Data if empty
        if (!localStorage.getItem('transactions')) {
            Store.set('transactions', [
                { id: 1, type: 'income', title: 'Salary', amount: 8000, date: new Date().toISOString().split('T')[0], category: 'Salary' }
            ]);
        }
        if(!localStorage.getItem('goals')) {
            Store.set('goals', [{ id: 1, title: 'New Laptop', targetAmount: 25000, savedAmount: 5000, priority: 'High' }]);
        }

        app.render();
    },

    renderDateSelectors: () => {
        const monthSel = document.getElementById('filter-month');
        const yearSel = document.getElementById('filter-year');
        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        
        monthSel.innerHTML = months.map((m, i) => `<option value="${i}" ${i === app.filter.month ? 'selected' : ''}>${m}</option>`).join('');
        
        const currentYear = new Date().getFullYear();
        let yearOpts = '';
        for(let y = currentYear; y >= currentYear - 2; y--) {
            yearOpts += `<option value="${y}" ${y === app.filter.year ? 'selected' : ''}>${y}</option>`;
        }
        yearSel.innerHTML = yearOpts;
    },

    updateDateFilter: () => {
        app.filter.month = parseInt(document.getElementById('filter-month').value);
        app.filter.year = parseInt(document.getElementById('filter-year').value);
        app.render();
    },

    navigate: (view) => {
        app.currentView = view;
        // Update Nav UI
        document.querySelectorAll('.nav-item, .mob-nav-item').forEach(el => {
            el.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'text-blue-600');
            if(el.classList.contains('nav-item')) el.classList.add('hover:bg-slate-800');
            else el.classList.add('text-slate-400');
        });
        
        const deskNav = document.getElementById(`nav-${view}`);
        if(deskNav) deskNav.classList.add('bg-blue-600', 'hover:bg-blue-700');
        
        const mobNav = document.getElementById(`mob-nav-${view}`);
        if(mobNav) { mobNav.classList.remove('text-slate-400'); mobNav.classList.add('text-blue-600'); }

        app.render();
    },

    render: () => {
        const main = document.getElementById('main-view');
        const allTrans = Store.get('transactions');
        const debts = Store.get('debts');
        const goals = Store.get('goals');

        // Filter Transactions based on Month/Year Dropdown
        const filteredTrans = MoneyFlowEngine.filterByDate(allTrans, app.filter.month, app.filter.year);
        const stats = MoneyFlowEngine.calculateStats(filteredTrans);

        if (app.currentView === 'dashboard') {
            // Get Previous Month for Comparison
            let prevM = app.filter.month - 1;
            let prevY = app.filter.year;
            if(prevM < 0) { prevM = 11; prevY--; }
            const prevTrans = MoneyFlowEngine.filterByDate(allTrans, prevM, prevY);
            const prevStats = MoneyFlowEngine.calculateStats(prevTrans);

            main.innerHTML = views.dashboard(stats, filteredTrans, prevStats, debts);
            setTimeout(() => app.renderDashboardCharts(filteredTrans), 100);
        } 
        else if (app.currentView === 'goals') {
            main.innerHTML = views.goals(goals);
            // Animate progress bars
            setTimeout(() => {
                document.querySelectorAll('[data-progress]').forEach(el => el.style.width = el.dataset.progress + '%');
            }, 50);
        }
        else if (app.currentView === 'transactions') {
            main.innerHTML = views.transactions(filteredTrans); // Show filtered history
        }
        else if (app.currentView === 'debts') {
            main.innerHTML = views.debts(debts);
            setTimeout(() => {
                document.querySelectorAll('[data-progress]').forEach(el => el.style.width = el.dataset.progress + '%');
            }, 50);
        }
        else if (app.currentView === 'settings') {
            main.innerHTML = views.settings();
        }
    },

    // --- CHART RENDERING ---
    renderDashboardCharts: (transactions) => {
        // Destroy old
        Object.values(chartInstances).forEach(c => c.destroy());
        chartInstances = {};

        // 1. Income vs Expense Bar
        const stats = MoneyFlowEngine.calculateStats(transactions);
        const ctxBar = document.getElementById('barChart');
        if(ctxBar) {
            chartInstances.bar = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: ['Income', 'Expense'],
                    datasets: [{
                        data: [stats.income, stats.expense],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderRadius: 8,
                        barThickness: 40
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } }
                }
            });
        }

        // 2. Expense Breakdown Donut
        const expMap = {};
        transactions.filter(t => t.type === 'expense').forEach(t => expMap[t.category] = (expMap[t.category] || 0) + parseFloat(t.amount));
        const ctxDonut = document.getElementById('donutChart');
        if(ctxDonut && Object.keys(expMap).length > 0) {
            chartInstances.donut = new Chart(ctxDonut, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(expMap),
                    datasets: [{
                        data: Object.values(expMap),
                        backgroundColor: ['#ef4444', '#f97316', '#f59e0b', '#84cc16', '#06b6d4', '#6366f1'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false } } }
            });
        }

        // 3. Daily Spending Line
        const trend = MoneyFlowEngine.getDailyTrend(transactions, app.filter.month, app.filter.year);
        const ctxLine = document.getElementById('lineChart');
        if(ctxLine) {
            chartInstances.line = new Chart(ctxLine, {
                type: 'line',
                data: {
                    labels: trend.labels,
                    datasets: [{
                        label: 'Daily Spending',
                        data: trend.data,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 2
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { display: false }, x: { display: false } }
                }
            });
        }
    },

    // --- ACTIONS ---
    addFundsToGoal: (id, amount) => {
        Store.updateGoal(id, amount);
        app.render();
    },
    
    // Add simple transaction delete/debt delete wrappers
    deleteTransaction: (id) => { if(confirm('Delete?')) { Store.delete('transactions', id); app.render(); } },
    deleteDebt: (id) => { if(confirm('Delete?')) { Store.delete('debts', id); app.render(); } },
    deleteGoal: (id) => { if(confirm('Delete?')) { Store.delete('goals', id); app.render(); } },
    payDebt: (id, amount) => {
        if(confirm(`Pay EGP ${amount}?`)) {
            const debts = Store.get('debts');
            const d = debts.find(x => x.id == id);
            if(d) {
                d.remainingAmount = Math.max(0, d.remainingAmount - parseFloat(amount));
                Store.set('debts', debts);
                Store.add('transactions', { type: 'expense', amount: amount, title: `Debt: ${d.title}`, category: 'Debt', date: new Date().toISOString().split('T')[0] });
                app.render();
            }
        }
    },
    
    // Export/Import/Reset logic same as before...
    logout: Auth.logout
};

// --- VIEWS ---
const views = {
    dashboard: (stats, transactions, prevStats, debts) => {
        const insights = MoneyFlowEngine.getInsights(transactions);
        const savingsDiff = stats.savingsRate - prevStats.savingsRate;
        
        // Calculate Previous Months List
        const allTrans = Store.get('transactions');
        const historyRows = [];
        // Simple way to get unique month keys
        const keys = [...new Set(allTrans.map(t => t.date.substring(0, 7)))].sort().reverse().slice(0, 6);
        keys.forEach(k => {
            if(k === `${app.filter.year}-${String(app.filter.month+1).padStart(2,'0')}`) return; // Skip current
            const [y, m] = k.split('-');
            const mTrans = MoneyFlowEngine.filterByDate(allTrans, parseInt(m)-1, parseInt(y));
            const mStats = MoneyFlowEngine.calculateStats(mTrans);
            historyRows.push({ date: k, ...mStats });
        });

        return `
            <div class="max-w-6xl mx-auto space-y-6">
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden">
                        <div class="text-sm text-gray-500 font-medium mb-1">Income</div>
                        <div class="text-2xl font-bold text-slate-800">EGP ${stats.income.toLocaleString()}</div>
                        <div class="absolute right-4 top-4 text-emerald-500 bg-emerald-50 p-2 rounded-lg"><i class="fa-solid fa-arrow-down"></i></div>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden">
                        <div class="text-sm text-gray-500 font-medium mb-1">Expenses</div>
                        <div class="text-2xl font-bold text-slate-800">EGP ${stats.expense.toLocaleString()}</div>
                        <div class="absolute right-4 top-4 text-rose-500 bg-rose-50 p-2 rounded-lg"><i class="fa-solid fa-arrow-up"></i></div>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden">
                        <div class="text-sm text-gray-500 font-medium mb-1">Net Balance</div>
                        <div class="text-2xl font-bold ${stats.net >= 0 ? 'text-blue-600' : 'text-red-500'}">EGP ${stats.net.toLocaleString()}</div>
                        <div class="absolute right-4 top-4 text-blue-500 bg-blue-50 p-2 rounded-lg"><i class="fa-solid fa-wallet"></i></div>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden">
                        <div class="text-sm text-gray-500 font-medium mb-1">Savings %</div>
                        <div class="text-2xl font-bold text-indigo-600">${stats.savingsRate.toFixed(1)}%</div>
                        <div class="text-xs ${savingsDiff >= 0 ? 'text-green-500' : 'text-red-500'} font-medium mt-1">
                            ${savingsDiff >= 0 ? '+' : ''}${savingsDiff.toFixed(1)}% vs last month
                        </div>
                        <div class="absolute right-4 top-4 text-indigo-500 bg-indigo-50 p-2 rounded-lg"><i class="fa-solid fa-percent"></i></div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Bar Chart -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-gray-800 mb-4 text-sm">Income vs Expense</h3>
                        <div class="h-48 relative"><canvas id="barChart"></canvas></div>
                    </div>
                    <!-- Donut Chart -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-gray-800 mb-4 text-sm">Spending Categories</h3>
                        <div class="h-48 relative flex justify-center"><canvas id="donutChart"></canvas></div>
                    </div>
                    <!-- Line Chart -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-gray-800 mb-4 text-sm">Daily Spending Trend</h3>
                        <div class="h-48 relative"><canvas id="lineChart"></canvas></div>
                    </div>
                </div>

                <!-- Monthly Insights -->
                ${insights ? `
                <div class="bg-gradient-to-r from-slate-800 to-slate-900 rounded-2xl p-6 text-white shadow-lg">
                    <h3 class="font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-lightbulb text-yellow-400"></i> Monthly Insights</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center text-rose-400 text-xl"><i class="fa-solid fa-calendar-day"></i></div>
                            <div>
                                <div class="text-slate-400 text-xs uppercase tracking-wider">Highest Spending Day</div>
                                <div class="font-bold text-lg">${insights.maxDay} <span class="text-sm font-normal text-slate-400">(EGP ${insights.maxDayAmount})</span></div>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center text-blue-400 text-xl"><i class="fa-solid fa-layer-group"></i></div>
                            <div>
                                <div class="text-slate-400 text-xs uppercase tracking-wider">Top Category</div>
                                <div class="font-bold text-lg">${insights.maxCat} <span class="text-sm font-normal text-slate-400">(EGP ${insights.maxCatAmount})</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}

                <!-- Previous Months -->
                ${historyRows.length > 0 ? `
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-5 border-b border-gray-100"><h3 class="font-bold text-gray-800">Previous Months</h3></div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-slate-500">
                                <tr>
                                    <th class="p-4 font-medium">Month</th>
                                    <th class="p-4 font-medium">Income</th>
                                    <th class="p-4 font-medium">Expense</th>
                                    <th class="p-4 font-medium">Net</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                ${historyRows.map(row => `
                                    <tr class="hover:bg-slate-50 transition-colors">
                                        <td class="p-4 font-bold text-slate-700">${row.date}</td>
                                        <td class="p-4 text-emerald-600">EGP ${row.income.toLocaleString()}</td>
                                        <td class="p-4 text-rose-600">EGP ${row.expense.toLocaleString()}</td>
                                        <td class="p-4 font-bold ${row.net >= 0 ? 'text-blue-600' : 'text-red-500'}">EGP ${row.net.toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                ` : ''}
                
                <!-- Saving Plan Shortcut -->
                <button onclick="app.navigate('goals')" class="w-full bg-indigo-50 border border-indigo-100 p-4 rounded-xl flex items-center justify-center gap-2 text-indigo-700 font-bold hover:bg-indigo-100 transition-colors">
                    <i class="fa-solid fa-piggy-bank"></i> Go to Savings Plan
                </button>
            </div>
        `;
    },

    goals: (list) => `
        <div class="max-w-6xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">Savings Goals</h2>
                <button onclick="modal.open('goal')" class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center shadow-lg hover:bg-blue-700 transition-transform active:scale-95"><i class="fa-solid fa-plus text-sm"></i></button>
            </div>
            
            <!-- Grid fix for Desktop -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                ${list.map(g => {
                    const progress = Math.min(100, (g.savedAmount / g.targetAmount) * 100);
                    return `
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 flex flex-col h-full">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-xl bg-yellow-50 flex items-center justify-center text-yellow-500 shadow-sm">
                                    <i class="fa-solid fa-trophy text-lg"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-800">${g.title}</h3>
                                    <span class="text-xs font-medium px-2 py-0.5 rounded bg-slate-100 text-slate-500">${g.priority} Priority</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-2 mb-6 flex-1">
                            <div class="flex justify-between text-sm">
                                <span class="text-slate-500">Saved</span>
                                <span class="font-bold text-emerald-600">EGP ${g.savedAmount.toLocaleString()}</span>
                            </div>
                            <div class="w-full bg-slate-100 rounded-full h-3">
                                <div class="bg-emerald-500 h-3 rounded-full transition-all duration-1000 ease-out" data-progress="${progress}" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-slate-400">
                                <span>${Math.round(progress)}%</span>
                                <span>Target: EGP ${parseFloat(g.targetAmount).toLocaleString()}</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mt-auto">
                            <button onclick="modal.openAddMoney(${g.id})" class="flex items-center justify-center gap-2 bg-slate-900 text-white py-2.5 rounded-xl text-sm font-semibold hover:bg-slate-800 transition-colors">
                                <i class="fa-solid fa-plus"></i> Add
                            </button>
                            <button onclick="app.deleteGoal(${g.id})" class="flex items-center justify-center bg-red-50 text-red-500 py-2.5 rounded-xl text-sm font-semibold hover:bg-red-100 transition-colors">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>`
                }).join('')}
            </div>
        </div>
    `,

    transactions: (list) => {
        const sorted = [...list].sort((a,b) => new Date(b.date) - new Date(a.date));
        return `
            <div class="max-w-5xl mx-auto">
                <div class="mb-6"><h2 class="text-xl font-bold text-gray-800">Transaction History</h2></div>
                <div class="space-y-3">
                    ${sorted.map(t => `
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-full flex items-center justify-center ${t.type === 'income' ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-600'}">
                                    <i class="fa-solid ${t.category === 'Food' ? 'fa-utensils' : t.category === 'Transport' ? 'fa-car' : 'fa-receipt'} text-lg"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-gray-800">${t.title}</div>
                                    <div class="text-xs text-gray-400">${t.date} • ${t.category}</div>
                                </div>
                            </div>
                            <div class="flex flex-col items-end gap-1">
                                <span class="font-bold ${t.type === 'income' ? 'text-emerald-600' : 'text-slate-800'}">
                                    ${t.type === 'income' ? '+' : '-'}EGP ${parseFloat(t.amount).toLocaleString()}
                                </span>
                                <button onclick="app.deleteTransaction(${t.id})" class="text-gray-300 hover:text-red-500 text-xs"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>`;
    },

    debts: (list) => `
        <div class="max-w-6xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">Debt Portfolio</h2>
                <button onclick="modal.open('debt')" class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center shadow-lg"><i class="fa-solid fa-plus text-sm"></i></button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                ${list.map(d => {
                    const progress = ((d.totalAmount - d.remainingAmount) / d.totalAmount) * 100;
                    return `
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 relative overflow-hidden">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="font-bold text-gray-800 text-lg">${d.title}</h3>
                                <p class="text-sm text-slate-500 flex items-center gap-1 mt-1"><i class="fa-solid fa-user text-xs"></i> ${d.person || 'Unknown'}</p>
                            </div>
                            <span class="text-xs font-bold bg-blue-50 text-blue-600 px-2 py-1 rounded-lg">${d.priority}</span>
                        </div>
                        <div class="flex justify-between text-xs mb-2 text-slate-500">
                            <span>Paid: ${(d.totalAmount - d.remainingAmount).toLocaleString()}</span>
                            <span>${Math.round(progress)}%</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2.5 mb-6">
                            <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" data-progress="${progress}" style="width: 0%"></div>
                        </div>
                        <div class="flex items-center justify-between border-t border-gray-50 pt-4">
                             <div>
                                <p class="text-xs text-slate-400">Remaining</p>
                                <p class="font-bold text-slate-800">EGP ${d.remainingAmount.toLocaleString()}</p>
                             </div>
                             <button onclick="app.payDebt(${d.id}, ${d.monthlyPayment})" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-blue-700">Pay EGP ${d.monthlyPayment}</button>
                        </div>
                    </div>`
                }).join('')}
            </div>
        </div>
    `,

    settings: () => `<div class="max-w-lg mx-auto bg-white p-8 rounded-2xl shadow-sm border border-gray-100 text-center"><h2 class="text-2xl font-bold mb-4">Settings</h2><button onclick="app.logout()" class="bg-red-50 text-red-600 px-6 py-3 rounded-xl font-bold hover:bg-red-100">Sign Out</button></div>`
};

// --- MODAL CONTROLLER ---
const modal = {
    open: (type) => {
        const overlay = document.getElementById('modal-overlay');
        const content = document.getElementById('modal-content');
        const title = document.getElementById('modal-title');
        const form = document.getElementById('dynamic-form');
        
        overlay.classList.remove('hidden');
        setTimeout(() => content.classList.remove('translate-y-full'), 10);

        let html = `<input type="hidden" name="type" value="${type}">`;
        const today = new Date().toISOString().split('T')[0];
        const inputClass = "w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all";
        const labelClass = "block text-sm font-semibold text-gray-700 mb-1.5 ml-1";

        if(type === 'income' || type === 'expense') {
            title.innerHTML = type === 'income' ? '<i class="fa-solid fa-arrow-down text-emerald-500"></i> Add Income' : '<i class="fa-solid fa-arrow-up text-rose-500"></i> Add Expense';
            html += `
                <div><label class="${labelClass}">Title</label><input type="text" name="title" required class="${inputClass}" placeholder="e.g. Salary"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="${labelClass}">Amount</label><input type="number" step="0.01" name="amount" required class="${inputClass}" placeholder="0.00"></div>
                    <div><label class="${labelClass}">Date</label><input type="date" name="date" value="${today}" required class="${inputClass}"></div>
                </div>
                <div><label class="${labelClass}">Category</label>
                <select name="category" class="${inputClass}">
                    ${type === 'income' ? '<option>Salary</option><option>Freelance</option><option>Other</option>' : '<option>Food</option><option>Transport</option><option>Housing</option><option>Entertainment</option><option>Health</option><option>Shopping</option>'}
                </select></div>`;
        } else if (type === 'debt') {
            title.innerHTML = 'Add Debt';
            html += `
                <input type="hidden" name="type" value="debt">
                <div><label class="${labelClass}">Title</label><input type="text" name="title" required class="${inputClass}"></div>
                <div><label class="${labelClass}">Person / Bank</label><input type="text" name="person" required class="${inputClass}"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="${labelClass}">Total</label><input type="number" step="0.01" name="totalAmount" required class="${inputClass}"></div>
                    <div><label class="${labelClass}">Monthly</label><input type="number" step="0.01" name="monthlyPayment" required class="${inputClass}"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="${labelClass}">Priority</label><select name="priority" class="${inputClass}"><option>High</option><option>Medium</option><option>Low</option></select></div>
                    <div><label class="${labelClass}">Due Date</label><input type="date" name="dueDate" required class="${inputClass}"></div>
                </div>`;
        } else if (type === 'goal') {
            title.innerText = 'Add Goal';
            html += `
                <input type="hidden" name="type" value="goal">
                <div><label class="${labelClass}">Title</label><input type="text" name="title" required class="${inputClass}"></div>
                <div><label class="${labelClass}">Target</label><input type="number" step="0.01" name="targetAmount" required class="${inputClass}"></div>
                <div><label class="${labelClass}">Priority</label><select name="priority" class="${inputClass}"><option>High</option><option>Medium</option><option>Low</option></select></div>`;
        }
        
        form.innerHTML = html;
        form.onsubmit = (e) => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(form).entries());
            if(data.type === 'debt') Store.add('debts', data);
            else if(data.type === 'goal') { data.savedAmount = 0; Store.add('goals', data); }
            else Store.add('transactions', data);
            modal.close();
            app.render();
        };
    },

    openAddMoney: (goalId) => {
        const overlay = document.getElementById('modal-overlay');
        const content = document.getElementById('modal-content');
        const title = document.getElementById('modal-title');
        const form = document.getElementById('dynamic-form');
        const today = new Date().toISOString().split('T')[0];
        const inputClass = "w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all";
        const labelClass = "block text-sm font-semibold text-gray-700 mb-1.5 ml-1";

        overlay.classList.remove('hidden');
        setTimeout(() => content.classList.remove('translate-y-full'), 10);
        
        title.innerHTML = '<i class="fa-solid fa-coins text-yellow-500"></i> Add Money to Goal';
        
        form.innerHTML = `
            <input type="hidden" name="type" value="add_fund">
            <div><label class="${labelClass}">Amount</label><input type="number" step="0.01" name="amount" required class="${inputClass}" placeholder="0.00"></div>
            <div><label class="${labelClass}">Date</label><input type="date" name="date" value="${today}" required class="${inputClass}"></div>
            <div><label class="${labelClass}">Notes (Optional)</label><textarea name="notes" class="${inputClass}" rows="2"></textarea></div>
        `;

        form.onsubmit = (e) => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(form).entries());
            app.addFundsToGoal(goalId, data.amount);
            modal.close();
        };
    },

    close: () => {
        const overlay = document.getElementById('modal-overlay');
        const content = document.getElementById('modal-content');
        content.classList.add('translate-y-full'); 
        setTimeout(() => overlay.classList.add('hidden'), 300);
    }
};

// Event Listeners
document.getElementById('login-form').addEventListener('submit', (e) => {
    e.preventDefault();
    Auth.login(document.getElementById('login-phone').value, document.getElementById('login-pass').value);
});

// Init
window.app = app;
document.addEventListener('DOMContentLoaded', Auth.check);

</script>
</body>
</html>
